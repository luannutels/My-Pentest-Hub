#!/bin/bash

################################################################################
# Title     : Pshtml                                                           #
# Version   : 1.0                                                              #
# Date      : 18/04/2023                                                       #
# Homepage  : https://github.com/luannutels                                    #
# Tested on : Linux                                                            #
# -----------------------------------------------------------------------------#
# Description:                                                                   #
#   This program has the function of looking for all the links that can be     #
#   considered useful for analysis, and check which of them are active.        #
#                                                                              #
################################################################################


RED='\033[31;1m'
GREEN='\033[32;1m'
YELLOW='\033[33;1m'
RED_BLINK='\033[31;5;1m'
END='\033[m'


ARG01="${1}"
ARG02="${2}"

VERSION='1.0'


trap __Ctrl_c__ INT


__Ctrl_c__() {
    __Clear__
    echo -e "\n${RED_BLINK}!!! Action aborted !!!${END}\n\n"
    exit 1
}


__Banner__() {
    echo -e "
        ${YELLOW}
        ################################################################################
        #                                                                              #
        #                                PSHTML                                        #
        #                 VOLK OFFENSIVE SECURITY by LUAN NUTELS                       #
        #                              Version ${VERSION}                                     #
        #                     https://github.com/luannutels                            #
        #                                                                              #
        ################################################################################
        ${END}

        Usage   : ${GREEN}${0}${END} [OPTION] [URL]
        Example : ${GREEN}${0}${END} www.website.com

        Try ${GREEN}${0} -h${END} for more options."
}


__Help__() {
    echo -e "
    NAME
        ${0} - Software for searching for links on web pages.

    SYNOPSIS
        ${0} [Options] [URL]

    DESCRIPTION
        The ${0} is used to look for links on web pages and check if they exist
        live hosts.

    OPTIONS
        -h, --help
            Shows the help menu.

        -v, --version
            Shows the program version.

        -f, --file
            Looks for links in the given file.
                Ex: ${0} -f file.txt"
}


__Verification__() {
    if ! [[ -e /usr/bin/wget ]]; then
        echo -e "\nMissing program ${RED}wget${END} to work.\n"
        exit 1
    elif ! [[ -e /usr/bin/host ]]; then
        echo -e "\nMissing program ${RED}host${END} to work.\n"
        exit 1
    fi

    if [[ "${ARG01}" == "" ]]; then
        __Banner__
        exit 1
    fi
}


__Clear__() {
    rm -rf /tmp/"${ARG01}" &>/dev/null
    rm -rf /tmp/tempfile &>/dev/null
}


__Download__() {

    __Clear__

    mkdir /tmp/"${ARG01}" && cd /tmp/"${ARG01}"

    echo -e "\n${GREEN}[+] Website download...${END}\n\n"
    if wget -q -c --show-progress "${ARG01}" -O FILE;then
        echo -e "\n${GREEN}[+] Download complete!${END}\n\n"
    else
        echo -e "\n${RED}[+] Download failed!${END}\n\n"
        exit 1
    fi
}


__OpenFile__() {
    if [[ "${ARG02}" == "" ]]; then
        echo -e "\n${RED}!!! File name required !!!${END}\n"
        exit 1
    elif ! [[ -e "${ARG02}" ]]; then
        echo -e "\n${RED}!!! File not found !!!${END}\n"
        exit 1
    fi

    __Clear__

    mkdir /tmp/tempfile
    cp "${ARG02}" /tmp/tempfile/FILE
    cd /tmp/tempfile
}


__FindLinks__() {
    sed -i "s/ /\n/g" FILE
    grep -E "(href=|action=)" FILE > .tmp1
    grep -oh '"[^"]*"' .tmp1 > .tmp2
    grep -oh "'[^']*'" .tmp1 >> .tmp2

    sed -i 's/"//g' .tmp2
    sed -i "s/'//g" .tmp2

    grep "\." .tmp2 | sort -u > links
}


__FindHosts__() {
    cp links links2
    sed -i "s/?/\n/g
            s/\/\/\//\n\/\//g" links2


    grep -oh "//[^/]*/" links2 > .tmp10
    grep -oh "//[^/]*" links2 >> .tmp10
    grep -oh "ww.*\.br" links2 >> .tmp10
    grep -oh "ww.*\.net" links2 >> .tmp10
    grep -oh "ww.*\.gov" links2 >> .tmp10
    grep -oh "ww.*\.org[^.]" links2 >> .tmp10
    grep -oh "ww.*\.com[^.]" links2 >> .tmp10

    sed -i "s/\///g" .tmp10
    grep "\." .tmp10 | sort -u > hosts
}


__LiveHosts__() {
    echo -e "${YELLOW}
################################################################################
#                              Active hosts                                    #
################################################################################
${END}"

     while read -r linha; do
        host "${linha}" 2>/dev/null | grep "has address" | awk '{print $4 "\t\t" $1}'
     done < hosts
}


__ShowLinks__() {
    echo -e "${YELLOW}
################################################################################
#                             Links found                                      #
################################################################################
${END}"

    while read -r linha; do
        echo "${linha}"
    done < links
}


__ShowHosts__() {
    echo -e "${YELLOW}
################################################################################
#                              Hosts found                                     #
################################################################################
${END}"

    while read -r linha; do
        echo "${linha}"
    done < hosts
}


__ShowResume__() {
    echo -e "
${YELLOW}================================================================================${END}
Found :
        $(wc -l links)
        $(wc -l hosts)
${YELLOW}================================================================================${END}"
}


__Main__() {
    __Verification__

    case "${ARG01}" in
        "-v"|"--version")
              echo -e "\nVersion: ${VERSION}\n"
              exit 0
        ;;
        "-h"|"--help")
              __Help__
              exit 0
        ;;
        "-f"|"--file")
              __OpenFile__
              __FindLinks__
              __ShowLinks__
              __FindHosts__
              __ShowHosts__
              __LiveHosts__
              __ShowResume__
              __Clear__
        ;;
        *) __Download__
           __FindLinks__
           __ShowLinks__
           __FindHosts__
           __ShowHosts__
           __LiveHosts__
           __ShowResume__
           __Clear__
        ;;
    esac
}

__Main__
